## 0. 顶栏信息

**「洛迪亚特区」**｜作者：**KIHAYYAN**
**协议**：CC BY-NC-SA 4.0
https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh-hans
**声明**：未经授权或未署名来源，禁止转载任何内容

**部署环境**：酒馆助手最新版｜SillyTavern **v1.13.0+**
**推荐模型**：**Gemini 3.0 Pro（仅推荐 3.0 Pro）**
**破限环境**：Kemini Aether（Gemini）（建议按要求缝合预设 CoT / 后置提示词）
**自定义建议**：世界书内 CoT 与预设文风建议自行缝合到预设，效果最佳

**简介**：时空交汇的法外之地；一张卡内整合历代核心对战机制（Mega / Z / 极巨化 / 太晶化）与强力训练家挑战。
**特有机制**：AVs 唯心战斗｜誓约遗物解锁机制｜洗翠古武（刚猛/迅疾）｜临场突破进化/羁绊共鸣

**⚠️排雷**：机制庞大且代码简化，特性/道具不全，BUG与平衡问题不可避免；无背包与经济系统。

**GitHub**：
- 状态栏 / Dashboard / 地图（pkm55）：https://github.com/hasheeper/pkm55/
- 战斗引擎（pkm33）：https://github.com/hasheeper/pkm33/

**链接**：
- 类脑原贴：https://discord.com/channels/1134557553011998840/1454707128429318348/1454707128429318348
- 酒馆助手定位：https://discord.com/channels/1134557553011998840/1296494001406345318/1296494001406345318
- Gemini3 预设：https://discord.com/channels/1134557553011998840/1339853575295209482/1339853575295209482
- ERA 原贴：https://discord.com/channels/1134557553011998840/1423319849400270928/1423319849400270928

## 1. TL;DR / 快速开始

### 1.1 你会获得什么体验
- **一张卡“缝合”历代对战机制**：Mega / Z / 极巨化 / 太晶化可并存使用（按剧情与解锁推进）。
- **可视化战斗与管理面板**：战斗前端 + 状态栏/Dashboard（队伍、PC、地图、交通、社交一体化）。
- **动漫逻辑魔改战斗（热血演出向）**：包含 **AVs 唯心修正、羁绊进化、生命进化、技能对冲** 等系统；在关键局面可能出现“锁血/必暴/逆转”等动画式表现。
- **强力训练家挑战 + 动态关系**：收录按二周目强度设计的历代训练家，并配套阶段性人设与动态好感系统。
- **知名角色反差/二创设定**：对部分宝可梦知名角色进行了二次创作与阶段性塑造。
- **开箱即用的配置**：已配置好的对手阵容与宝可梦配置（队伍/配招/机制标记等），上手即可玩。
- **合理型缝合的同人世界观**：在“多世代机制并存”的前提下给出相对自洽的世界观解释与创作框架。
- **双体验沉浸**：底层会产生战斗/变量等“结构化信息”，最终由 **LLM 负责演绎成叙事文本**；世界书会在后台为“战斗记录 → 文本体验”提供支撑，让你同时获得**系统感**与**剧情沉浸感**。

---

### 1.2 这是什么 / 不是什么
**这是什么：**
- 一个基于 SillyTavern 的**长线沙盒式宝可梦同人 TRPG 卡**：你扮演训练家在「洛迪亚特区」探索、对战、推进关系与解锁机制。
- 一个“**系统 + 演绎**”混合体验：底层有变量与前端系统支撑（队伍/地图/关系/战斗等），最终由 **LLM 把过程演绎成剧情文本**。

**这不是什么：**
- 不是传统意义上的“原作复刻”或严格竞技对战模拟器（机制有大量动画逻辑魔改、并且为兼容进行了简化）。
- 不是带完整 RPG 经济/背包/任务系统的正统游戏（偏探索+脑补驱动的沙盒）。

---

### 1.3 适合人群
推荐给：
- 喜欢宝可梦、并想要“**机制对战 + 剧情演绎**”同时存在的人。
- 喜欢收集/养成/攻略 NPC、接受阶段性人设与二创设定的人。

不太推荐给：
- 只想纯聊天、快手冲、完全不想碰变量/前端/配置的人。
- 对宝可梦相关完全抓瞎，不知道干什么的
- 对对战平衡性与无 bug 有强迫症的人（本作明确存在简化与不可避免的问题）。
- 需要背包、经济、明确任务链条驱动的传统 RPG 玩家。

---

### 1.4 遇到问题先看这里（最常见）
- **网络/前端加载问题**：先确保你的网络配置能正常访问 GitHub Pages（必要时使用代理/分流）。
- **酒馆助手脚本未启用**：检查酒馆助手的**角色卡局内脚本**是否处于开启状态（不是关闭/禁用）。很多“悬浮球不出现 / 面板不工作 / 数据不刷新”都源于这里。
- **酒馆助手版本过旧**：确保酒馆助手为**最新版本**（旧版可能出现 ERA 同步、注入、正则链路异常）。
- **预设不匹配导致格式输出异常**：推荐使用 **Kemini（Gemini）预设**；其他预设不做保障，可能更容易出现标签/JSON/格式不稳定。

---

### 1.5 推荐设置（新手）
- **模型**：只推荐 **Gemini 3.0 Pro**。
  原因：宝可梦相关**数据库/知识库最稳**、体验也最多元；且本卡的机制、输出格式与整体体验都是以 **Gemini 3.0 Pro** 为基准做过调整的。
- **预设与文风（重要）**：建议按说明将 **预设缝合** 与 **文风提示词**配置好（**照图设置即可**）。
  - 重点：把世界书内提供的 **CoT/后置提示词/文风建议**按要求缝合进你的预设里，能显著减少格式问题与跑偏。
![参考图](https://files.catbox.moe/hnzr40.png)


## 2. 特性

### 2.1 持久化数据（ERA 存档）
- 本卡使用 **ERA** 做存档与状态管理。
- **主要用途**：
  - **回滚**（出问题/打崩了可以回退）
  - **重算变量** 已知BUG，在切换到其他变量卡可能会导致本卡变量全崩，需要打开ERA重算变量解决
  - **全数据导出**：`{{ERA:$ALLDATA}}`（一次性导出当前完整存档，粘贴到任意上下文）
- 如需**配置修改变量/自定义字段**：请直接参考 **ERA 原贴**（本帖不做展开）。

---

### 2.2 NPC 角色书 与 Token 消耗
- **常驻 token**：约 **10k** 左右（随上下文/触发略有浮动）。
- **角色条目规模**：共 **28 个角色**，单角色信息平均约 **1.5k**。
- **实际触发量**：常见对话中平均会触发约 **8 个**条目（取决于你提到的角色/地点/关键词）。
- 角色普遍为**“自带队伍 + 二周目挑战强度”**定位，偏“强敌/高强度对手”，而非传统成长型劲敌。

---

## 3. 使用指南

### 3.1 选择开局（主开局 / 空白 / 演示）
- **默认开局（推荐第一次玩）**：有完整开场白 + 自动初始化变量，直接进入洛迪亚特区的剧情导入。
- **空白开局（自由度最高）**：只有初始化变量；适合想自定义训练家设定、初始队伍与背景的人。
- **战斗演示（排查/体验用）**：
  - **演示 1：普通战斗**——用于确认战斗前端、流程与基础机制是否能正常运行。
  - **演示 2：机制全开**——用于体验 Mega / Z / 极巨化 / 太晶化 + 对冲/古武等系统上限，也适合测试输出格式是否稳定。

---

### 3.2 队伍与 PC 盒子管理
- **队伍（PARTY）**：在 Dashboard 的 **PARTY** 页面查看 6 个槽位宝可梦，支持查看配招/道具/关键数值与机制标记。
  - 可通过**小旗子图标**切换 `isLead`（队长/先发），决定**第一只出战**的宝可梦。
  - **注意**：队伍/数值等变量原则上由 **AI 按规则更新**。
  - 目前**没有完整的“技能/招式学习系统”**（也未做相关汉化流程）；需要依靠 **AI 演绎**或玩家自行口胡/互动来推动获得招式、调整配招等剧情行为。
- **PC 盒子（BOX）**：用于队伍与盒子之间的**存取/交换**。
  - 支持**单选/多选**，可一次性执行：**放入 / 放出 / 交换**等批量操作。
  - 操作完成后会生成一段可复制的指令（包含 `VariableEdit/VariableInsert` 等），需要你**手动复制并粘贴**回 SillyTavern 发送给 AI 执行。
  - 若出现 **SIGNAL LOST**：这通常**不是 BUG**，而是**“信号覆盖”机制**生效（你当前不在 PC 信号范围内）。按地图指引靠近终端或回到可用区域即可；该机制的规则会在后文详细说明。

#### BOX 信号覆盖机制（Box-Link Signal）

对应实现：`app.js` → `isInSignalCoverage` + BOX UI 模块。

- **覆盖判定**：
  1. 玩家位于 **Z 区（Zenith 中枢）** → 默认全覆盖，随时可用 BOX 功能。
  2. 其他区域需在任意 **PC_Terminal** 的信号半径内（`PC_SIGNAL_RADIUS = 3` 格 ≈ 1.2 km）。距离计算基于地图格坐标。
- **状态写入**：`renderBoxPage()` 会调用 `isInSignalCoverage(x, y)`，结果存入 `boxState.signalStatus`：
  - `covered: true` → BOX 页面解锁，可正常选中队伍槽/盒子格。
  - `covered: false` → 触发 `boxState.isLocked`，整页加上 `.locked`，所有交互按钮与格子点击会被拦截。
- **离线遮罩**：
  - 会显示 “SIGNAL LOST / ERR_SIGNAL_WEAK” 覆盖层，提示当前位置、最近信号塔坐标、直线距离以及所需半径。
  - 同时在终端窗口输出诊断信息（找到多少个终端、最近距离等），方便定位最近的 PC_Terminal。
- **恢复方式**：
  - 移动到任何 PC_Terminal 3 格内，或直接返回 Z 区，即可在下一次刷新 BOX 页面时自动解锁。
  - 推荐随身携带 PC 终端坐标（Transit 面板会列出终端/车站位置），在野外规划补给点。
- **常见疑问**：
  - **为何盒子突然锁定？** 大概率因为角色跑出了信号范围，非脚本崩溃。
  - **信号塔在哪里看？** 大地图的服务设施图层的PC_Terminal。

---

### 3.3 旅行与地图系统
- **地图（MAP）**分为两种视图：

  - **大地图（全局视图）**：用于查看当前位置与整体区域信息。
    - 支持查看/切换多种**图层信息**（地形、威胁、区域划分等），并显示**设施、地标、NPC 所在地**等（具体以图层面板为准，后文会详细介绍）。
    - 支持**旅程模式（路线规划）**：
      - `Shift + 左键` 添加定位点（可多点规划旅途）。
      - 再次点击某个点可取消该点位。
      - 完成后会**自动生成对应提示词并复制到剪贴板**，你只需粘贴回酒馆让 AI 执行移动与演绎。

  - **战术图（近景/战术视图）**：用于更细粒度的移动与遭遇。
    - **地图规模**：当前为 **52 × 52** 的大地图格网。
    - **生态覆盖**：野生池大致覆盖 **800+ 宝可梦**、**40+ 二级神**，并包含**全异兽 / 古代种 / 未来种**等特殊生态。
      - **注意**：**一级神**与**幻之宝可梦**默认**不会自然刷新**（需要你通过口胡/剧情演绎/事件链来获取；具体机制会在后续“剧透/机制详解”章节说明）。
    - **短距离行动**：可选择移动到**距离不超过 2 格**的目标地点（偏“短距离行动/战术位移”）。
    - **主动遭遇**：可点击**遭遇（Encounter）**按钮，主动触发“脚下地块”的宝可梦遭遇战斗，并将触发信息交给 AI 处理与演绎。

- **交通（TRANSIT）**：用于跨区域移动（环线列车 / 空运 / 海运）。一般流程为：先在本区步行到站点 → 再使用交通网络跨区。
- 旅行/换区后，**位置会写入 ERA 存档**，并影响后续可触发的事件、NPC 与场景描述。

---

### 3.4 NPC 互动与好感度
- NPC 的互动与“阶段性人设”主要依赖 **对话触发 + 世界书注入**。
- **建议尽早触发**：第一次见面时尽量先把该 NPC 的条目触发出来（直接说出她的中文名/英文名/日文名之一）。
  - 如果在**未触发条目**的情况下就强行推进初见剧情，模型可能以“白板人设”临时发挥，后续行为与设定一致性会变差。

- **好感度系统**：目前主要面向**八位女主角**。
  - 当好感达到 **80** 时，会获得对应的**羁绊道具**：AI 会演绎授予剧情、并同步更新变量，具体机制下面会说明。
  - Dashboard/状态栏里对应的**胶囊条图标会点亮**（请自行检查是否亮起以确认生效）。
  - 其他 NPC 目前以**阶段性人设**为主，暂不没有同规格的羁绊道具链路。

- **队伍配置与强度**：
  - 每个角色都规划了对应的队伍配置；但实际对战时 AI 可能会基于平衡与场景，生成一套“与配置接近”的队伍（尤其在作为对手出场时）。
  - **馆主/冠军**通常具备 **Tier 1–4** 多档队伍；其他女主角/NPC 多数只提供 **Tier 4**（偏二周目强度）。

- **对战形式说明**：目前默认是**单打**，暂无完整“双打系统”。
  - 但你可以让 AI 按角色配置把对方的宝可梦“安排进剧情/协同作战”等变体玩法；具体处理方式与注意事项会在机制章节说明。

---

## 4. 机制说明（简略）

### 4.1 ERA 变量：记录了什么
把 ERA 理解为本作的“存档系统”。你在游玩中的**队伍、位置、时间、NPC 好感、机制解锁、设置开关**都会被记录下来，保证可以长线推进、也方便出问题时回滚。

---

#### 1) 设置开关 = 你这局能不能用哪些机制
Dashboard 里的设置不是装饰，它会**直接决定战斗相关机制是否启用**，尤其是：

- **AVs（唯心战斗）**：核心总开关。
  这是很多动画系系统的“底座”。如果你关掉它，后续的战术面板、进化/突破、技能对冲等可能会出现不触发或表现异常。

- **Commander（战术面板）**：战斗中出现的“四个战术选项”。大体效果是：
  - 快避开：更容易闪避
  - 击中要害：更容易暴击
  - 快清醒：更容易清除负面状态
  - 撑下去：更容易锁 1 血/硬撑不倒

- **EVO（突破/进化相关）**：包含**生命进化**与**羁绊进化**（需要后续解锁，细节后讲）。

- **Clash（技能对冲）**：默认关闭，但可以开启，招式“互相碰撞/对拼”的系统（复杂度高，后文单独讲）。

- **BGM / SFX**：音频开关。

---

#### 2) 训练师熟练度 = “动画主角力”的权重
你会有一个“训练师熟练度”的成长条，它会影响很多“临场发挥”类事件的成功率与表现强度。
**熟练度越高**，越容易打出更符合动画逻辑的操作与逆转（尤其与战术面板、对冲表现相关）。

---

#### 3) 解锁分两类：机制解锁 vs 羁绊解锁
你会遇到两种“解锁”：

- **机制解锁**：纯粹决定你能不能使用 Mega / Z / 极巨化 / 太晶 / 古武 / 杀意感知等功能。
- **羁绊解锁**：偏“女主角路线”的奖励/钥匙（例如羁绊道具）。它通常不仅解锁机制，还会带来剧情演绎与关系推进。

---

#### 4) 队伍信息：你最需要关注的只有三件事
在 PARTY 页面里你主要关心：

- **先发（队长）**：用小旗子设置，决定第一只出战。
- **王牌标记**：你的宝可梦默认更偏“动画主角队”，很多演出更倾向围绕王牌触发。
- **AVs 四维情感（唯心战斗的核心）**：
  - 信赖（Trust）：偏锁血/硬撑
  - 热情（Passion）：偏暴击/爆发
  - 洞察（Insight）：偏闪避/看破
  - 奉献（Devotion）：偏自愈/治疗
这些数值越高，越容易在关键回合“演出来”。

---

#### 5) 满队获得新宝可梦：会先进入“缓冲位”，再自动进盒子
当你队伍 6 只满员时，如果又获得新宝可梦，它不会硬塞进队伍，而是先进入一个**临时缓冲位**，正常情况下会被系统/脚本**自动转存到 PC 盒子**。
如果你发现“满队后宝可梦不见了/没进盒子”，优先检查：脚本是否启用、是否按流程操作。

---

#### 6) 位置与时间：影响你能遇到什么、触发什么
- **位置（坐标/区域）**会影响：地图显示、设施可用性、NPC 触发、野生刷新、事件链等。
- **时间（日期/时段）**主要由 AI 推进与调整；若出现不稳定属于已知情况，后续会给处理建议。

---

#### 7) 异变与野生刷新：让“世界是活的”
- **异变系统**：用于控制异兽/古代/未来等特殊生态或事件状态（后文详述）。
- **野生刷新缓存**：你走到哪就在哪刷，避免反复读档刷同一格；通常按“以玩家为中心的小范围”生成，并会随日期刷新。

---

#### 8) NPC 好感：有阶段、有阈值、有剧情
NPC 好感会分阶段推进（从敌对到亲密的多个阶段），通常通过“本次互动增长值”结算。
对**八位女主角**而言，好感到达关键阈值会触发羁绊道具与对应演绎（并点亮状态栏图标）。

---

> 想看/备份完整存档：`{{ERA:$ALLDATA}}`
> 想改数值/调变量：请看 ERA 原贴（开发者向内容放在后续章节）。


### 4.2 队伍数据结构要点
你的队伍固定为 **6 个槽位**。每只宝可梦在系统里会被当成“一张完整的角色数据卡”，主要由以下几类信息构成：

- **基础信息**：种族/昵称、性别、等级、闪光、性格、特性、携带道具等。
  这些决定了宝可梦“是谁”、大致定位是什么，也会影响 AI 演绎时的口径。

- **招式（4 格）**：当前更偏“展示 + 叙事驱动”。
  也就是说：系统会记录你现在用什么招式，但**没有完整的学习/遗忘/招式机器流程**；通常需要你和 AI 通过剧情训练、传授、口胡等方式推进。

- **机制标记**：用于标注这只宝可梦“当前能走哪些机制路线”（例如 Mega / Z / 极巨化 / 太晶 / 羁绊等），以及太晶属性等信息。
  这些标记会决定战斗演绎时 AI 能不能合理让你开某些按钮/触发某些演出。

- **先发与王牌**：
  - **先发（Lead）**：决定你第一只上场的宝可梦（在 PARTY 页面用小旗子切换）。
  - **王牌（Ace）**：偏“动画主角队”的设定标记；很多羁绊/热血演出会优先围绕王牌触发。
  （通常更倾向让你的 6 只都具备王牌属性）

- **AVs（唯心羁绊四维）**：信赖 / 热情 / 洞察 / 奉献。
  它们不是装饰，而是动画逻辑系统的核心“加成来源”，大体对应：
  - 信赖：更容易硬撑、锁血
  - 热情：更容易暴击、爆发
  - 洞察：更容易闪避、看破
  - 奉献：更偏自愈、治疗与续航

---

#### 关于 IV / EV
- **IV（个体值）**：遵循宝可梦原本的“出生决定论”逻辑。
  你获得这只宝可梦时会生成/确定一次六维，之后基本**固定不变**（属于“这只个体的天赋底子”）。

- **EV（努力值）**：做了显著简化。
  本作不拆成六维努力分配，而是用一个**统一强度等级**来表达（上限按 255 思路处理），等价于“整体成长/熟练度”。
  体感上会比原作更“省心”，也更偏爽快成长（理论上强度上限会更高一些）。

---

### 4.3 解锁与开关（Mega / Z / Max / Tera / …）
本作的世代机制**不是默认全开**，而是按“剧情推进 + 角色关系 + 传授/誓约”逐步解锁。解锁后会体现在三处：
1) 战斗中可用的按钮/机制
2) Dashboard 的机制图标点亮
3) AI 的演绎口径与判定（能不能用、怎么用、会不会触发演出）

---

#### 1) 八大机制：与“八位女主角”绑定的解锁体系
本作一共有**八个机制模块**，分别对应八位女主角的关系线。
- 这里**不做剧透**具体“谁对应什么”，只需要知道：
  - 当你与对应角色的好感达到关键节点后，AI 会用剧情把“钥匙/信物/传授”交给你，并同步点亮机制图标。
  - 这部分是全卡体验的核心之一，到了阶段建议让剧情走稳一点（别跳过关键互动/奖励桥段）。

---

#### 2) 四大世代机制需要“道具/钥匙”解锁宝可梦侧的机制锁
即使你“账号层面”解锁了某个机制，很多时候还需要满足“宝可梦侧”的条件，AI 才会给你开按钮：

- **Mega / Z / 极巨化 / 太晶化**通常都需要对应的**道具/信物/装置**，由 AI 在变量中授予并“解锁机制锁”。
- **太晶化额外要求**：需要指定（或在剧情中确定）该宝可梦的**太晶属性**，否则很难稳定实现对应机制表现。

> 体感上你可以理解为：
> “我学会了机制” ≠ “我手上有能用的装置” ≠ “这只宝可梦已被授权/适配”。

---

#### 3) 不想走好感线？可以走“手动配置”路线
如果你不想通过好感度/剧情慢慢拿钥匙，本作也允许你直接配置（相当于“跳过解锁流程”）。
- 我会在后续章节给出**非剧透的修改方法与注意事项**（以及对应的改哪些项）。

---

#### 4) 其他机制（古武/突破/共鸣等）
除四大世代机制外，本作还有偏“动画逻辑”的机制模块，例如：
- **古武（刚猛/迅疾）**：操纵行动顺序与威力取舍
- **AVS 突破 / 羁绊共鸣 / 训练师突破**：更偏热血演出与关键回合逆转
这些同样属于“解锁后才稳定生效”的内容，并会随你的关系推进与剧情进度逐步开放。

---

### 4.4 战斗系统概览
- **核心机制**：战斗系统整体**基本遵循宝可梦原版回合制对战逻辑**（回合、先制、属性克制、状态、换人等），并通过可视化战斗前端展示回合流程、技能选择与结算。由庞大的JS编码计算，AI基本完全不参与。
- **覆盖规模（引擎侧）**：目前引擎数据覆盖约：
  - 招式 **900+**
  - 常见特性 **160+**
  - 对战道具 **200+**
  但由于本作需要兼容大量机制与演绎体验，部分招式/特性/道具可能存在**BUG、简化或不完整实现**。请不要把它当作“纯竞技模拟器”来要求。

- **叙事层（双体验）**：战斗过程会产生结构化结算与过程信息，随后由 **LLM 转写/演绎为剧情文本**，形成“战斗像在玩、剧情像在看”的双沉浸体验。

- **对战形式**：目前默认是**单打**；双打等复杂模式不是主要支持项（如要玩可通过 AI 演绎/口胡变体实现）。

- **逃跑规则（宽松）**：考虑到二周目强敌/NPC 对战密度，**逃跑不做限制**，通常视为 **100% 可逃**（用来止损/跳过不想打的战斗）。


---

### 4.5 特色系统：AVS / 对冲 / 古武 / 杀意感知 / 指挥 /（生命&羁绊进化）
本作的“动画逻辑魔改”主要集中在以下系统，它们会让战斗更像动画而不是纯竞技：

- **AVS 系统（唯心战斗）**
  可以理解为把原作“好感度/亲密度”的效果**拆分成更细的机制版本**：宝可梦对你的情感会以不同维度影响战斗表现（例如更容易暴击、闪避、硬撑、恢复等）。
  这也是许多演出型系统的底座（关掉 AVS 往往会连带影响其它系统的触发/表现）。

- **技能对冲（Clash）**
  在特定条件下模拟“招式碰撞/对拼”，强调演出张力与博弈感：同回合互攻时可能触发对冲判定，出现压制、僵持、反推等动画式镜头。（细节较复杂，后文会单独展开）

- **古武流派（刚猛 / 迅疾）**
  类似洗翠战斗风格：通过“刚猛/迅疾”的取舍来改变行动顺序与威力，制造策略差与翻盘空间。

- **杀意感知（Insight）**
  当对手的行动对你构成明显威胁时，会给出“危险预警/直觉提示”，让你更像动画里的训练师能提前察觉危机并调整策略。

- **训练家指挥（Commander）**
  满足条件时可触发战术面板指令，用于强化关键回合的战术选择（偏演绎+战术增强，常见是闪避、暴击、清负面、硬撑等）。

- **生命进化（战斗中进化）**
  当 AVS（情感/羁绊）累积达到要求，且宝可梦等级/进化条件接近达成时，允许在战斗中直接触发进化演出，主打热血临场突破。

- **羁绊进化（逆风共鸣）**
  更偏“绝境翻盘”的系统：在大逆风、尤其是最后一只宝可梦的关键时刻，有机会触发羁绊共鸣与形态突破（用于制造动画级逆转瞬间）。

---

### 4.6 捕获与成长
- **遭遇方式**：本作理论上**没有强制遭遇**。主要来源于两类：
  1) **地图系统的主动遭遇**（你点“遭遇/Encounter”触发脚下地块的野生战斗）
  2) **LLM 演绎的剧情遭遇**（剧情需要时由 AI 安排事件/冲突/野生出现）

- **升级与成长（非严格经验制）**：
  - 本作升级**不是原作那套严格经验值计算**，而是偏“叙事节奏”的大致成长。
  - 体感上平均**一场战斗约 1–2 级**（视战斗强度与剧情权重浮动）。
  - 等级与成长通常由 **AI 负责更新**；EV（努力值简化系统）也同理，偏“整体成长等级”而非六维精细分配。

- **捕捉规则（无背包前提下的替代方案）**：
  由于目前没有完整道具/经济系统，精灵球采用**自选制**：**普通 / 高级 / 大师**。
  你可以根据当前剧情与氛围自行选择并让 AI 演绎：想写实就用普通/高级，想快速收队或保底就用大师。

- **临场突破（演出型成长）**：
  一些关键成长会以“战斗演出”方式呈现（例如战斗中进化、觉醒、羁绊共鸣等），用于强化逆风翻盘与热血瞬间的可玩性。

---


## 5. 进阶玩法与变量详解（剧透区/开发者向）


### 5.1 ERA 变量结构深度解析
本节为**进阶用户**准备。
如果你需要手动修改存档、Debug、或者想理解系统底层逻辑，请阅读本节。
导出变量请使用：`{{ERA:$ALLDATA}}`
*注：以下 JSON 片段仅为核心结构示意，非完整代码。*

---

#### A) settings：系统内核开关
这部分直接决定战斗系统的底层机制是否运作。如果随意关闭，会导致战斗前端功能失效。

```json
"settings": {
  "enableAVS": true,        // [重要] 唯心战斗总开关
  "enableCommander": true,  // 战术面板开关
  "enableEVO": true,        // 生命/羁绊进化开关
  "enableBGM": true,        // 背景音乐
  "enableSFX": true,        // 音效
  "enableClash": false      // 技能对冲开关 (默认需解锁或配置)
}
```
**关键解析**：
- **`enableAVS`**：**核心根基**。Commander(战术)、EVO(进化)、Clash(对冲) 全部依赖 AVS 数值运算。如果设为 `false`，后面三个系统即使开启也会失效或不触发。
- **`enableCommander`**：战斗底部的“战术命令”按钮：
  - **快避开** $\rightarrow$ (对应 AVS Insight) $\rightarrow$ 闪避加成
  - **击中要害** $\rightarrow$ (对应 AVS Passion) $\rightarrow$ 暴击率加成
  - **快清醒** $\rightarrow$ (对应 AVS Devotion) $\rightarrow$ 清除异常状态
  - **撑下去** $\rightarrow$ (对应 AVS Trust) $\rightarrow$ 锁 1 血 / 硬撑
- **`enableEVO`**：允许战斗中进行非标准进化（如满羁绊后的临场进化）。

---

#### B) player：玩家状态与解锁表
```json
"player": {
  "name": "{{user}}",
  "trainerProficiency": 0,    // 训练师熟练度
  "proficiency_up": 0,        // 熟练度增量(AI写入)

  "bonds": { ... },           // 女主角羁绊道具锁
  "unlocks": { ... }          // 纯机制锁
}
```
**关键解析**：
- **`trainerProficiency` (训练师熟练度)**：
  - 这是一个数值（0~255），并不只是装饰。
  - 它直接作为参数参与 **Clash (对冲判定)** 和 **Commander (战术成功率)** 的公式计算。**熟练度越高**，你就越容易触发动画级的“拼招胜利”或“极限闪避”。
- **`bonds` vs `unlocks`**：
  - `bonds_` 开头的：代表是否获得了**八位女主角专属的羁绊道具**（如 Mega 手环、Z 强力手环等）。
  - `unlocks_` 开头的：单纯的机制开关（是否允许使用对应的战斗功能）。
  - *一般流程下，获得 Bond 会同时开启 Unlock；Debug 时可直接改 Unlock 跳过剧情。*

---

#### C) party：队伍核心结构 (Slot 1-6)
此处以 `slot1` 为例，这是每只宝可梦的数据实体：

```json
"slot1": {
  "slot": 1,
  "nickname": "皮卡丘",     // 推荐用昵称
  "species": "Pikachu",
  "lv": 50,
  "isAce": true,            // [王牌标记] 默认玩家队伍 6 只都为 True
  "isLead": true,           // [先发标记] 决定首发，UI小旗子控制

  "friendship": {
    "avs": { 
        "trust": 0,        // 信赖 -> 锁血/硬撑
        "passion": 0,      // 热情 -> 暴击
        "insight": 0,      // 洞察 -> 闪避
        "devotion": 0      // 奉献 -> 自愈/治疗
    }
  },

  "mechanic": "mega",       // 当前可用的机制 (mega/zmove/dynamax/tera)
  "teraType": "Electric",   // 太晶属性 (若 mechanic="tera" 则必需)

  "stats_meta": {
    "ivs": { ... },         // 必须有，通常获得时生成并固定
    "ev_level": 255         // 努力在等级，简化为单一数值，越高越强
  }
}
```
**关键解析**：
- **Pokemon 命名**：系统优先读取 `nickname` 显示在前端，`species` 用于调取图鉴数据。
- **`isAce` (王牌)**：动画逻辑开关。本卡为了保障玩家体验，玩家所有宝可梦默认设为 Royal/Ace 单位，享受额外演出权重。
- **Transfer Buffer (`transfer_buffer` / `slot7`)**
  - **机制**：当 slot1-6 满员，玩家获得**第 7 只**宝可梦时，AI 会将其填入这个临时对象。
  - **处理**：状态栏脚本检测到 slot7 有数据时，会自动将其移动到 **PC 盒子 (box)** 并清空 buffer。
  - **故障排查**：如果你满队抓宠卡住了，检查此变量是否有残留数据，或脚本是否被拦截。

---

#### D) world_state：世界与环境
```json
"world_state": {
  "location": {
    "region": "Z",  // 脚本自动注入
    "x": -5,
    "y": -5         // 玩家或 UI 更新坐标
  },

  "phenomenon": {
    "active_type": "clear",   // clear, ultra, ancient, future
    "active_region": "none"   // 异变发生的区域
  },

  "pokemon_spawns": {},       // 野生刷新缓存

  "time": {
    "day": 1,
    "period": "morning",
    "derived": { "dayOfYear": 1 ... } // 实际核心数值
  }
}
```
**关键解析**：
- **位置与刷新 (`pokemon_spawns`)**：
  - 刷新不是全局随机，而是**玩家走到哪刷到哪**（以玩家坐标为中心，半径 R=2）。
  - 刷新结果会写入 `pokemon_spawns` 并**本游戏日内持久不予变动**（避免 SL 大法反复刷同一格）。次日清空。
- **异变 (`phenomenon`)**：
  - 控制**究极异兽 / 悖论种（古代/未来）** 是否刷新。
  - `clear` 代表无异变。

---

#### E) world_state.npcs：好感度阶段
```json
"npcs": {
  "rosa": { 
     "stage": 0,   // 当前阶段 (-2 至 4)
     "love": 0,    // 总好感度
     "love_up": 0  // 本轮增量
  }
}
```
**阶段阈值机制**：
- 共有 **7 个阶段**（Stage -2 ~ Stage 4）。
- **默认阈值**：**20 / 40 / 60 / 80**。
  - Stage 0 $\to$ 1 (20)
  - Stage 2 $\to$ 3 (60)
  - Stage 3 $\to$ 4 (80, 满羁绊)
- 每次对话结算时，脚本会将 `love_up` 加到 `love` 里并清零，若超过阈值则提升 `stage`。
- **女主角专属**：到达 Stage 4 (80 love) 时，会点亮 Dashboard 对应图标并发放专属羁绊道具。

---

## 5.2 AVS 系统的具体修正和机制

### AVS 四维情感系统概述

**AVS (Affection Value System)** 是本作的核心"唯心战斗"系统，将原作的"好感度/亲密度"拆分为四个独立维度，每个维度数值范围为 **0-255**：

- **Trust (信赖)**：影响锁血保命能力
- **Passion (热情)**：影响暴击概率
- **Insight (洞察)**：影响闪避能力和杀意感知
- **Devotion (奉献)**：影响自愈和异常状态清除

**重要限制**：
- 只有标记为 **王牌 (isAce)** 的宝可梦才能触发 AVS 被动效果
- 大部分 AVS 效果每场战斗只能触发一次
- 当 AVS 系统全局关闭时，所有效果失效

---

### 四维效果详解

#### 1. Trust (信赖) - 同步守护系统

**核心机制**：当宝可梦受到致命伤害时，有概率锁血至 1 HP，避免阵亡。

**触发概率计算**：
- 公式：`触发概率 = (Trust / 255) × 50%`
- Trust 60 → 11.76% 概率
- Trust 100 → 19.6% 概率
- Trust 255 (满值) → **50%** 概率

**触发条件**：
1. 宝可梦是王牌 (isAce)
2. 受到的伤害 ≥ 当前 HP
3. 本场战斗尚未触发过 Trust 锁血

**效果**：
- 当前 HP 锁定为 1
- 显示特殊日志："凭借与训练家的羁绊，用脸接下了致命一击！"
- 每场战斗限触发 **1 次**

**战术指令联动**：
- **ENDURE! 指令**可额外获得 Trust 加成
- 基础成功率 50% + (Trust/255) × 50%
- 满 Trust 时 ENDURE 指令 100% 成功

---

#### 2. Passion (热情) - 暴击强化系统

**核心机制**：提升暴击概率，但**不影响暴击倍率**（固定 1.5x）。

**暴击概率加成**：
- 公式：`暴击加成 = (Passion / 255) × 20%`
- Passion 0 → 无加成
- Passion 100 → +7.8% 暴击率
- Passion 255 (满值) → **+20%** 暴击率

**实际效果示例**：
- 基础暴击率（无暴击等级）：4.17% (1/24)
- 满 Passion 后：**24.17%** 暴击率
- 配合暴击等级 +1：12.5% → **32.5%**
- 配合暴击等级 +2：50% → **70%**

**战术指令联动**：
- **FOCUS! 指令**直接提升暴击等级 +2
- 不与 Passion 冲突，可叠加

**注意**：Passion 只影响暴击**概率**，暴击倍率始终为 1.5x，不会因 Passion 提升。

---

#### 3. Insight (洞察) - 预知闪避系统

**核心机制**：降低敌方命中率，并能预警敌方招式。

**闪避加成计算**：
- 公式：`命中率降低 = (Insight / 255) × 10%`
- Insight 100 → 敌方命中率 -3.9%
- Insight 255 (满值) → 敌方命中率 **-10%**
- 最低命中率保底：**50%**（即使 Insight 满值，敌方至少有 50% 命中率）

**奇迹闪避 (Miracle Dodge)**：
- 当 Insight ≥ 250 时，面对**绝对命中招式**（Z 招式/极巨招式）有概率触发奇迹闪避
- Insight 250-254 → 5% 概率
- Insight 255 (满值) → **10%** 概率
- 成功时完全闪避绝对命中招式

**杀意感知 (Insight Prewarning)**：
- 当玩家后手时，系统会预测 AI 的招式选择
- 根据 Insight 数值显示不同等级的预警信息：

| Insight 数值 | 预警等级 | 显示信息 |
|-------------|---------|---------|
| 50-149 | Level 1 | 感知到"有攻击意图" |
| 150-219 | Level 2 | 知道属性类型 |
| 220-254 | Level 3 | 知道物理/特殊分类 |
| 255 (满值) | Level 4 | 知道具体招式名称 |

**战术指令联动**：
- **DODGE! 指令**基础闪避 30% + (Insight/255) × 30%
- 满 Insight 时 DODGE 指令提供 **60%** 闪避率（敌方命中率降至 40%）

---

#### 4. Devotion (奉献) - 献身治愈系统

**核心机制**：回合结束时有概率清除异常状态或回复 HP。

**触发概率计算**：
- 基础公式：`触发概率 = (Devotion / 255) × 35%`
- Devotion 10 → 1.37% 概率
- Devotion 100 → 13.7% 概率
- Devotion 255 (满值) → **35%** 概率

**效果类型**：

**① 异常状态清除**（每回合判定）：
- 当宝可梦处于异常状态（中毒/麻痹/灼伤/冰冻/睡眠）时触发
- 成功时：清除异常状态 + 回复 **15% 最大 HP**
- 每回合都会判定（不限次数）

**② 危机爆发回复**（全局限 1 次）：
- 触发条件：HP ≤ 30%
- 触发概率：基础概率 × 1.5（最高 60%）
  - Devotion 100 → 20.6% 概率
  - Devotion 255 → **52.5%** 概率（上限 60%）
- 成功时：回复 **35% 最大 HP**
- 每场战斗限触发 **1 次**

**战术价值**：
- 高 Devotion 宝可梦可持续作战，抵抗消耗战
- 配合残血锁血机制（Trust），形成"不死小强"战术

---

### 羁绊共鸣 (Bond Resonance)

**触发条件**（需同时满足）：
1. 队伍中只剩 **最后一只** 宝可梦存活
2. 该宝可梦是 **王牌 (isAce)**
3. 玩家已解锁 **enable_bond** 机制（Rosa 好感度 80）
4. AVS 四维总和 ≥ **300**

**效果加成**：
- 全能力值（攻击/防御/特攻/特防/速度）**×1.3**
- 暴击率额外 **+2 档**（约 +46% 暴击率）
- 闪避率额外 **+50%**（敌方命中率 -50%）
- Trust 锁血概率额外 **+50%**（满 Trust 时接近 100%）

**战术意义**：
- 绝境翻盘机制，鼓励"最后的王牌"战术
- 配合高 AVS 宝可梦，可在 1v3 劣势下逆转战局

---

### 生命进化 (Life Evolution)

**触发条件**（需同时满足）：
1. 宝可梦满足进化条件（等级/道具/亲密度）
2. AVS 四维总和达到阈值
3. 玩家已解锁 **enable_evo** 机制
4. 宝可梦未处于 Mega/极巨化状态

**阈值计算**：
- 公式：`所需 AVS 总和 = 400 + (等级 × 2)`
- Lv.50 → 需要 AVS 总和 ≥ **500**
- Lv.75 → 需要 AVS 总和 ≥ **550**
- Lv.100 → 需要 AVS 总和 ≥ **600**

**特殊机制**：
- **羁绊挺住 (Bond Endure)**：当满足进化条件时，受到致命伤害会自动锁血至 1 HP，并显示进化按钮
- 进化后保留当前 HP 百分比
- 进化后 AVS 数值不变，但能力值重新计算

**战术价值**：
- 鼓励培养低等级宝可梦，通过 AVS 累积实现战斗中进化
- 进化时机可控，可选择最佳时机进化以获得能力提升

---

## 5.3 熟练度系统、命令面板与对冲系统

### 训练师熟练度 (Trainer Proficiency)

**数值范围**：0-255

**影响系统**：
1. **对冲触发概率**：熟练度越高，双方攻击时触发对冲的概率越高
2. **战术指令成功率**：影响 Commander 面板的出现频率
3. **古武风格效果**：影响风格切换的战术价值

**成长机制**：
- 每场战斗根据表现获得熟练度增量
- 增量写入 `player.proficiency_up`，由 AI 在对话中结算
- 初始上限为 **128**，解锁 May 的 `enable_proficiency_cap` 后提升至 **255**

---

### 战术指令面板 (Commander System)

**触发条件**：
- 需要解锁 `enable_commander` 机制
- 每回合开始时根据熟练度判定是否显示指令面板
- 触发概率：`min(80%, 熟练度 / 320)`
  - 熟练度 80 → 25% 概率
  - 熟练度 160 → 50% 概率
  - 熟练度 255 (满值) → **79.7%** 概率（上限 80%）

**四大战术指令**：

#### 1. 快避开 (DODGE!) - 对应 Insight
- **基础效果**：命中率降低 30%（敌方命中率 70%）
- **Insight 加成**：额外降低 (Insight/255) × 30%
- **满 Insight 效果**：命中率降低 60%（敌方命中率 40%）
- **使用后消耗**：当回合结束后失效

#### 2. 击中要害 (FOCUS!) - 对应 Passion
- **效果**：暴击等级 **+2**（暴击率提升至 50%）
- **Passion 联动**：与 Passion 被动暴击加成叠加
- **满 Passion 效果**：50% + 20% = **70%** 暴击率
- **使用后消耗**：当回合结束后失效

#### 3. 快清醒 (CLEAR!) - 对应 Devotion
- **基础效果**：50% 概率清除异常状态
- **Devotion 加成**：额外 +(Devotion/255) × 50%
- **满 Devotion 效果**：**100%** 清除异常状态
- **使用后消耗**：当回合结束后失效

#### 4. 撑下去 (ENDURE!) - 对应 Trust
- **基础效果**：50% 概率锁血至 1 HP
- **Trust 加成**：额外 +(Trust/255) × 50%
- **满 Trust 效果**：**100%** 锁血成功
- **使用后消耗**：当回合结束后失效
- **注意**：与 Trust 被动锁血独立，可在同一场战斗中分别触发

---

### 对冲系统 (Clash System)

**触发条件**（需同时满足）：
1. 双方都选择**攻击招式**（非变化技）
2. 招式满足对冲条件（非声音技、非场地技、非守住状态）
3. 熟练度判定成功

**触发概率**：
- 公式：`触发概率 = 熟练度 / 340`
- 熟练度 85 → 25% 概率
- 熟练度 170 → 50% 概率
- 熟练度 255 (满值) → **75%** 概率

---

#### Clash Type (对冲类型) 推导

招式根据 flags 自动分类为四种对冲类型：

| Clash Type | 识别标志 | 代表招式 |
|-----------|---------|---------|
| **SOLID** | contact flag | 近身战、十字劈、近身拳 |
| **BEAM** | bullet/pulse flag | 波导弹、龙之波动、气合弹 |
| **WAVE** | wind/sound flag | 暴风、空气斩、热风 |
| **PIERCE** | slicing flag | 十字剪、劈瓦、圣剑 |

**特殊招式覆盖**：
- 部分招式有硬编码类型（如"破坏光线"强制为 BEAM）
- 优先级：硬编码 > flags 推导 > 默认 SOLID

---

#### 对冲交互矩阵

不同类型对冲时的优势关系：

| 对冲组合 | 结果 | 优势修正 | 描述 |
|---------|------|---------|------|
| BEAM vs PIERCE | PIERCE 胜 | -0.5 | 切开光束 |
| SOLID vs WAVE | SOLID 胜 | +0.8 | 突破波动 |
| PIERCE vs PIERCE | 平手 | 暴击+0.5 | 交叉斩击 |
| BEAM vs BEAM | 平手 | 0 | CP 对拼 |
| WAVE vs WAVE | 平手 | 0 | 波动抵消 |
| SOLID vs SOLID | 平手 | 0 | 硬碰硬 |

---

#### CP (Clash Power) 计算

**基础公式**：
```
CP = 威力 × (攻击力/100) × 属性克制 × Clash Type 优势 × 特殊招式加成 × 随机数(0.85-1.0)
```

**特殊招式加成**：
- Z 招式：**×1.5**
- 极巨招式：**×1.3**
- 普通招式：×1.0

**速度修正**：
- **后手方 CP 削弱**：`0.7 + (慢速/快速) × 0.3`（范围 0.7-1.0）
- **先手方 CP 加成**：`1.0 + (1 - 慢速/快速) × 0.3`（范围 1.0-1.3）

---

#### 对冲结果判定

根据双方 CP 比值决定伤害倍率：

| CP 比值 | 结果等级 | 胜方伤害 | 败方伤害 | 描述 |
|---------|---------|---------|---------|------|
| ≥ 2.0 | **Overpower** | 100% | 0% | 碾压 |
| 1.5-2.0 | **Dominate** | 60-100% | 0% | 压制 |
| 1.15-1.5 | **Pierce** | 30-60% | 0% | 略胜 |
| 0.87-1.15 | **Neutralize** | 20-50% | 20-50% | 势均力敌 |
| < 0.87 | 反向判定 | - | - | 对方占优 |

**Z 招式/极巨招式保底**：
- Z 招式即使被完全抵消，也至少造成 **30%** 伤害
- 极巨招式即使被完全抵消，也至少造成 **20%** 伤害

---

## 5.4 古武系统 (Move Styles)

### 三种风格概述

**风格序列**：道 (Normal) → 迅 (Agile) → 刚 (Strong) → 道 (循环)

**解锁条件**：
- 需要解锁 `enable_styles` 机制（Akari 好感度 80）
- 解锁后显示太极球 UI，可点击切换风格

---

### 风格效果详解

#### 1. 道 (Normal) - 平衡风格
- **优先度修正**：0（无修正）
- **威力修正**：×1.0（无修正）
- **冷却时间**：无
- **战术定位**：标准输出，无副作用

---

#### 2. 迅 (Agile) - 迅疾风格
- **优先度修正**：**+1**（类似先制技）
- **威力修正**：**×0.75**（威力降低 25%）
- **冷却时间**：2 回合
- **战术用途**：
  - 抢先手击杀残血敌人
  - 配合 Insight 预警打断敌方强力招式
  - 速度劣势时的翻盘手段
  - 破坏对方 Trick Room（戏法空间）战术

**示例**：
- 原威力 100 的招式 → 威力 75，但优先度 +1
- 可在敌方使用前先手攻击

---

#### 3. 刚 (Strong) - 刚猛风格
- **优先度修正**：**-1**（后手攻击）
- **威力修正**：**×1.5**（威力提升 50%）
- **冷却时间**：2 回合
- **战术用途**：
  - 一击必杀高防御敌人
  - 配合 Trust 锁血后的反击
  - 破盾/破防（突破 Disguise、Ice Face 等特性）
  - 配合 Trick Room 在慢速队中先手输出

**示例**：
- 原威力 100 的招式 → 威力 150，但优先度 -1
- 适合坦克型宝可梦使用

---

### 冷却机制

**冷却显示**：
- 使用迅疾/刚猛风格后，太极球变灰并显示"休"字
- 冷却期间无法切换风格，强制使用道风格
- 每回合开始时冷却计数器 -1

**冷却递减**：
- 使用迅疾/刚猛后：`playerStyleCooldown = 2`
- 第 1 回合结束：`playerStyleCooldown = 1`
- 第 2 回合结束：`playerStyleCooldown = 0`（解除冷却）

**战术建议**：
- 在关键回合使用风格技能，平时使用道风格积攒冷却
- 迅疾适合速攻队，刚猛适合坦克队
- 配合对冲系统，可在 CP 计算中获得优势

---

## 5.5 战斗 AI 的分配和逻辑

### AI 难度等级

本作实现了四个 AI 难度等级，分别对应不同的决策策略：

| 难度 | 决策策略 | 适用场景 |
|------|---------|---------|
| **Easy** | 80% 随机，20% 最优 | 新手训练家、路人 NPC |
| **Normal** | 60% 最优，30% 次优，10% 随机 | 普通训练家、道馆学徒 |
| **Hard** | 100% 最优 | 道馆馆主、四天王 |
| **Expert** | 战术 AI（换人/预判/斩杀） | Boss 战、传说训练家 |

---

### 招式评分系统

AI 通过多维度评分系统选择最优招式：

#### 评分因素（按权重排序）

**1. 斩杀加成**（最高优先级）：
- 如果招式伤害 ≥ 对方当前 HP
- 评分 **+500**
- 确保 AI 优先击杀残血目标

**2. 基础伤害评分**：
- 评分 = 预计伤害值
- 通过模拟计算获得（`isSimulation: true`）

**3. 属性克制加成**：
- 效果绝佳（≥2x）：**+200** 分
- 效果不佳（≤0.5x）：**-100** 分
- 鼓励 AI 使用克制招式

**4. 命中率惩罚**：
- 评分 **×(命中率/100)**
- 例如：命中率 70% 的招式，总分 ×0.7
- 降低不稳定招式的优先级

**5. 副作用评分**：
- 自我强化（如剑舞）：**+100** 分
- 异常状态（如催眠术）：**+80** 分
- 鼓励 AI 使用辅助招式

**6. 折返技能评分**：
- U-turn、Volt Switch 等：根据换人价值动态评分
- 如果场上不利，折返技能评分提升

---

### Expert AI 换人决策

Expert 难度 AI 具备主动换人能力，判定条件如下：

#### 换人触发条件（满足任一即换人）

**1. 属性劣势检查**：
- 如果对方属性克制己方 > 1.5 倍
- 且队伍中有更优选择
- 触发换人

**2. 负面状态清除**：
- 如果攻击力/特攻降低 ≥ 2 档
- 换人以清除能力降低
- 避免成为累赘

**3. 濒死保护**：
- 如果 HP < 20% 且宝可梦是脆皮输出手
- 换人保护核心战力
- 避免被对方白嫖击杀

**4. 战术换人**：
- 如果已完成钉子布置（Stealth Rock 等）
- 且核心输出手尚未登场
- 换入核心进行输出

**5. 破盾后换人**：
- 如果成功破除对方护盾特性（Disguise、Ice Face）
- 换入克制宝可梦进行收割

---

### AI 特性评估

Expert AI 能够识别并针对性破解防御机制：

#### 一次性护盾特性

| 特性 | 破盾价值 | 条件 | 破盾标志 |
|------|---------|------|---------|
| **Disguise** (画皮) | 350 | 无 | `disguiseBusted` |
| **Ice Face** (冰面) | 300 | 物理攻击 | `iceFaceBusted` |

**破盾战术**：
1. AI 优先使用低威力招式破除护盾
2. 破盾后换入高输出宝可梦
3. 使用高威力招式击杀

#### 满血减伤特性

| 特性 | 破盾价值 | 条件 |
|------|---------|------|
| **Multiscale** (多重鳞片) | 150 | 满 HP |
| **Shadow Shield** (幻影防守) | 150 | 满 HP |

**应对战术**：
- AI 优先使用连续攻击招式（如 Bullet Seed）
- 第一击破除减伤，后续击造成全额伤害

#### 满血保命特性

| 特性 | 破盾价值 | 条件 |
|------|---------|------|
| **Sturdy** (结实) | 200 | 满 HP |

**应对战术**：
- AI 使用两段攻击：先触发 Sturdy 锁 1 血，再补刀击杀
- 或使用连续攻击招式一次性击杀

---

## 5.6 四大机制的还原和微调

### Mega 进化系统

#### 自动检测机制

系统通过读取 Pokedex 的 `otherFormes` 字段自动检测可用形态：

**检测流程**：
1. 读取宝可梦的 `otherFormes` 列表
2. 筛选包含 "Mega" 关键字的形态
3. 如果有多个 Mega 形态（如喷火龙、超梦），标记为双 Mega
4. 设置 `canMegaEvolve = true` 并记录目标形态 ID

**双 Mega 选择**：
- **喷火龙**：Mega X (龙/火，物攻型) / Mega Y (火/飞，特攻型)
- **超梦**：Mega X (超能/格斗，物攻型) / Mega Y (超能，特攻型)
- 触发对话框让玩家选择，根据队伍配置决定

#### Mega 进化限制

- 每场战斗限用 **1 次**（全队共享）
- 需要解锁 `enable_mega` 机制（Serena 好感度 80）
- 宝可梦需要携带对应的 Mega 石（通过 `mechanic: 'mega'` 标记）
- Mega 后无法切换回原形态，直到战斗结束

---

### Z 招式系统

#### 专属 Z 优先级机制

本作实现了**单一 Z 锁定策略**，每只宝可梦只能使用优先级最高的专属 Z：

**优先级列表**（部分）：
1. **10,000,000 Volt Thunderbolt**（智皮卡丘 Z）- 最高优先级
2. **Catastropika**（皮卡丘 Z）
3. **Light That Burns the Sky**（奈克洛兹玛 Z）
4. **Oceanic Operetta**（西狮海壬 Z）
5. **Guardian of Alola**（卡璞 Z）

**推导逻辑**：
1. 遍历宝可梦的所有招式
2. 检查 `招式ID + 宝可梦ID` 是否在专属 Z 矩阵中
3. 如果有多个专属 Z，选择优先级最高的
4. 其他招式**不能**变成通用 Z（如电 Z、火 Z）

**战术意义**：
- 避免专属 Z 宝可梦滥用通用 Z
- 保持专属 Z 的稀有性和战术价值
- 例如：智皮卡丘只能用智皮 Z，不能用普通电 Z

---

### 极巨化系统

#### G-Max 检测机制

系统通过 `GMAX_SPECIES_DATA` 表检测宝可梦是否有超极巨形态：

**检测流程**：
1. 提取宝可梦的基础种族 ID（去除形态后缀）
2. 查询 G-Max 表，检查是否有对应的超极巨招式
3. 如果有，标记为 G-Max 宝可梦；否则为普通极巨化

**G-Max 招式映射**（部分）：
- **喷火龙** → G-Max Wildfire（超极巨地狱灭焰）
- **皮卡丘** → G-Max Volt Crash（超极巨万雷轰顶）
- **卡比兽** → G-Max Replenish（超极巨满腹大作战）

#### 威力计算特殊规则

**格斗系/毒系极巨招式威力稍低**：
- 原因：平衡性考虑（格斗/毒系极巨招式附加效果强）
- 威力上限：150 → **100**，110 → **95**

**通用威力计算**：
- 基础威力 ≥ 150 → 极巨威力 **150**
- 基础威力 ≥ 110 → 极巨威力 **140**
- 基础威力 ≥ 75 → 极巨威力 **130**
- 基础威力 < 75 → 按比例缩放

#### HP 倍增机制

- **常规极巨化**：HP **×1.5**
- **无极汰那**：HP **×1.82**，Def/SpD **×2.63**（Boss 专属）
- HP 倍增后，当前 HP 按比例提升
- 极巨化结束后，HP 按比例还原

---

### 太晶化系统

#### 属性变更机制

**太晶化后的属性规则**：
1. 宝可梦的**防御属性**变为太晶属性（单属性）
2. 招式的**攻击属性**不变，但 STAB 加成规则改变
3. 如果招式属性 = 太晶属性，STAB 加成提升至 **2.0x**（原版 1.5x）
4. 如果招式属性 = 原生属性，STAB 加成为 **1.5x**（回忆加成）

**示例**：
- 水/地 宝可梦太晶化为火属性
- 使用火系招式：STAB **2.0x**（太晶加成）
- 使用水系招式：STAB **1.5x**（回忆加成）
- 使用地系招式：STAB **1.5x**（回忆加成）
- 使用其他招式：无 STAB

#### Tera Blast 特判

**Tera Blast（太晶爆发）** 是太晶化专属招式，具有特殊机制：

**属性变更**：
- 太晶化前：普通系，威力 80
- 太晶化后：属性变为**太晶属性**

**分类变更**（根据攻击/特攻决定）：
- 如果攻击 > 特攻 → 物理招式
- 如果特攻 ≥ 攻击 → 特殊招式
- 动态适配宝可梦的输出能力

**战术价值**：
- 为物攻手提供特攻打击手段（反之亦然）
- 配合太晶属性，实现属性覆盖战术

---

## 5.7 八大机制的解锁详细展开

### 解锁机制与女主角对应

本作设计了 **8 个核心机制**，分别对应 **8 位女主角**，通过好感度系统逐步解锁：

| 女主角 | 解锁机制 | 好感度要求 | 羁绊道具 |
|-------|---------|-----------|---------|
| **Rosa** | 羁绊进化 (enable_bond) | 80 | 羁绊之证 |
| **Akari** | 古武风格 (enable_styles) | 80 | 洗翠古武传承 |
| **Dawn** | 杀意感知 (enable_insight) | 80 | 直觉之证 |
| **Serena** | Mega 进化 (enable_mega) | 80 | Mega 手环 |
| **Selene** | Z 招式 (enable_z_move) | 80 | Z 强力手环 |
| **Gloria** | 极巨化 (enable_dynamax) | 80 | 极巨腕带 |
| **Juliana** | 太晶化 (enable_tera) | 80 | 太晶珠 |
| **May** | 熟练度上限解锁 (enable_proficiency_cap) | 80 | 训练师证明 |

---

### 1. Rosa - 羁绊进化 (enable_bond)

**解锁剧情**：
- Rosa 好感度达到 80（Stage 4）
- 触发羁绊道具授予剧情，获得"羁绊之证"

**机制效果**：
1. **羁绊共鸣系统**：最后一只王牌宝可梦 AVS ≥ 300 时，全能力 ×1.3
2. **甲贺忍蛙羁绊进化**：击杀敌方后变为小智版（Battle Bond 特性）
3. **生命进化系统**：满足条件时可在战斗中进化

**战术价值**：
- 绝境翻盘核心机制
- 鼓励培养单核王牌战术
- 配合高 AVS 宝可梦，实现 1v6 逆转

---

### 2. Akari - 古武风格 (enable_styles)

**解锁剧情**：
- Akari 好感度达到 80
- 获得"洗翠古武传承"，学习太极拳法

**机制效果**：
1. 解锁太极球 UI（右下角圆形按钮）
2. 可切换三种风格：道/迅/刚
3. 迅疾风格：优先度 +1，威力 ×0.75
4. 刚猛风格：优先度 -1，威力 ×1.5

**战术价值**：
- 提供优先度控制能力
- 速攻队使用迅疾抢先手
- 坦克队使用刚猛打爆发

---

### 3. Dawn - 杀意感知 (enable_insight)

**解锁剧情**：
- Dawn 好感度达到 80
- 获得"直觉之证"，觉醒预知能力

**机制效果**：
1. 解锁 Insight 预警系统
2. 后手时预测 AI 招式（4 级预警）
3. Insight ≥ 250 时可闪避绝对命中招式（5-10% 概率）

**战术价值**：
- 提供情报优势，预判敌方行动
- 配合 DODGE 指令，实现极限闪避
- 高 Insight 宝可梦可无视 Z 招式/极巨招式

---

### 4. Serena - Mega 进化 (enable_mega)

**解锁剧情**：
- Serena 好感度达到 80
- 获得"Mega 手环"，解锁 Mega 进化能力

**机制效果**：
1. 解锁 Mega 进化按钮（战斗界面）
2. 携带 Mega 石的宝可梦可 Mega 进化
3. 每场战斗限用 **1 次**（全队共享）

**战术价值**：
- 大幅提升单只宝可梦的能力值
- 改变属性/特性，实现战术转换
- 双 Mega 宝可梦可根据对局选择形态

---

### 5. Selene - Z 招式 (enable_z_move)

**解锁剧情**：
- Selene 好感度达到 80
- 获得"Z 强力手环"，解锁 Z 招式

**机制效果**：
1. 解锁 Z 招式按钮（战斗界面）
2. 可使用通用 Z（如电 Z、火 Z）或专属 Z（如智皮 Z）
3. 每场战斗限用 **1 次**（全队共享）

**战术价值**：
- 提供超高威力的一次性爆发
- 专属 Z 附带特殊效果（如智皮 Z 必定麻痹）
- 配合对冲系统，Z 招式 CP ×1.5

---

### 6. Gloria - 极巨化 (enable_dynamax)

**解锁剧情**：
- Gloria 好感度达到 80
- 获得"极巨腕带"，解锁极巨化

**机制效果**：
1. 解锁极巨化按钮（战斗界面）
2. HP ×1.5，持续 **3 回合**
3. 招式变为极巨招式/超极巨招式

**战术价值**：
- 提供持续 3 回合的强化状态
- 极巨招式附带场地效果（如极巨雷电设置电气场地）
- 超极巨招式附带独特效果（如超极巨地狱灭焰持续灼伤）

---

### 7. Juliana - 太晶化 (enable_tera)

**解锁剧情**：
- Juliana 好感度达到 80
- 获得"太晶珠"，解锁太晶化

**机制效果**：
1. 解锁太晶化按钮（战斗界面）
2. 属性变为太晶属性（单属性）
3. STAB 加成提升至 **2.0x**

**战术价值**：
- 改变属性弱点，规避克制
- 提升 STAB 加成，增强输出
- 配合 Tera Blast，实现属性覆盖

---

### 8. May - 熟练度上限解锁 (enable_proficiency_cap)

**解锁剧情**：
- May 好感度达到 80
- 获得"训练师证明"，突破熟练度上限

**机制效果**：
1. 熟练度上限从 **128** 提升至 **255**
2. 解锁更高的对冲触发率（最高 75%）
3. 解锁更高的战术指令成功率（最高 80%）

**战术价值**：
- 后期成长核心机制
- 提升战术操作上限
- 配合高熟练度，实现稳定对冲触发

---

## 5.8 mechanics/form-change 的特殊处理

### 形态变化类型总览

本作实现了 **7 种形态变化类型**，涵盖历代所有形态变化机制：

| 类型 | 触发方式 | 代表宝可梦 | 持续时间 |
|------|---------|-----------|---------|
| **Mega Evolution** | 按钮触发 | 喷火龙、超梦、路卡利欧 | 战斗结束 |
| **Ultra Burst** | 按钮触发 | 奈克洛兹玛（合体后） | 战斗结束 |
| **Primal Reversion** | 进场自动 | 固拉多、盖欧卡 | 战斗结束 |
| **Crowned Form** | 进场自动 | 苍响、藏玛然特 | 战斗结束 |
| **Battle Bond** | 击杀触发 | 甲贺忍蛙 | 战斗结束 |
| **HP-Threshold Forms** | HP 变化触发 | 弱丁鱼、基格尔德、小陨星、达摩狒狒 | 动态变化 |
| **Necrozma Fusion** | 开局触发 | 奈克洛兹玛 + 索尔迦雷欧/露奈雅拉 | 战斗结束 |

---

### 通用形态变化核心

所有形态变化共享统一的 `performFormChange` 函数，确保一致性：

**变化流程**：
1. 读取目标形态的 Pokedex 数据
2. 更新宝可梦的名称、属性、种族值
3. 更新特性（如果新形态有不同特性）
4. 重新计算能力值（攻击/防御/特攻/特防/速度）
5. **HP 处理**：大部分形态保持 HP 不变，仅基格尔德完全体重新计算 HP
6. 标记已变形状态 (`isTransformed = true`)

**HP 保持机制**：
- 原因：避免形态变化成为免费回血手段
- 例外：基格尔德 10%/50% → 完全体时，HP 按比例提升（唯一例外）

---

### 进场自动变形 (Init-Transform)

**适用形态**：
- **Primal Reversion**（原始回归）：固拉多、盖欧卡
- **Crowned Form**（剑盾之王）：苍响、藏玛然特

**触发时机**：
1. 宝可梦进场时（`onSwitchIn` 钩子）
2. 战斗开始时（`battleStart` 钩子）

**实现机制**：
- 宝可梦携带标记：`needsInitTransform = true`
- 记录目标形态：`initTransformTarget = 'groudonprimal'`
- 进场时自动执行 `performFormChange`

**战术意义**：
- 原始回归提供强大的天气控制（大日照/大雨）
- 剑盾之王提供属性变化和能力提升

---

### 击杀触发变形 (Battle Bond)

**适用宝可梦**：
- **甲贺忍蛙**（Battle Bond 特性）

**触发条件**：
1. 甲贺忍蛙击杀敌方宝可梦
2. 特性为 Battle Bond
3. 尚未变为小智版（`greninjaash`）

**变化效果**：
- 变为小智版甲贺忍蛙
- 能力值大幅提升（特攻/速度）
- 外观变化（头部水手里剑）

**战术价值**：
- 雪球机制，击杀后越战越强
- 配合高速高攻，实现连续收割

---

### 血量阈值触发变形

#### 1. 弱丁鱼 (Wishiwashi) - 鱼群特性

**变化条件**：
- **聚集形态 → 单独形态**：HP ≤ 25%
- **单独形态 → 聚集形态**：HP > 25%

**能力差异**：
- 聚集形态：高攻高防高特防（种族值总和 620）
- 单独形态：极低能力值（种族值总和 175）

**战术意义**：
- 满血时是超强坦克
- 残血后极度脆弱，需要及时换下

---

#### 2. 基格尔德 (Zygarde) - 群聚变形特性

**变化条件**：
- **50% 形态 → 完全体**：HP < 50%
- 每场战斗限触发 **1 次**（`_zygardeTransformed` 标记）

**能力差异**：
- 50% 形态：平衡型（种族值总和 600）
- 完全体：超高 HP/攻击/防御（种族值总和 708）

**特殊处理**：
- **唯一例外**：变为完全体时，HP 按比例重新计算
- 例如：50% 形态 HP 100/200 → 完全体 HP 108/216（比例保持）

**战术意义**：
- 残血触发后获得大量 HP，实现翻盘
- 配合 Trust 锁血，可稳定触发完全体

---

#### 3. 小陨星 (Minior) - 界限盾特性

**变化条件**：
- **核心形态 → 流星形态**：HP > 50%
- **流星形态 → 核心形态**：HP ≤ 50%

**能力差异**：
- 流星形态：高防御/特防，低速度
- 核心形态：低防御/特防，高速度/攻击

**战术意义**：
- 满血时是坦克，残血后变速攻手
- 配合壳甲破碎（Shell Smash），实现极限输出

---

#### 4. 达摩狒狒 (Darmanitan) - 达摩模式特性

**变化条件**：
- **标准模式 → 达摩模式**：HP ≤ 50%
- **达摩模式 → 标准模式**：HP > 50%

**能力差异**：
- **标准模式**：高攻击，物理输出手
- **达摩模式**：高特攻，特殊输出手

**地区差异**：
- **普通达摩狒狒**：火系 → 火/超能系
- **伽勒尔达摩狒狒**：冰系 → 冰/火系

**战术意义**：
- 残血后改变输出方式，出其不意
- 伽勒尔形态获得火系，弥补冰系弱点

---

### Necrozma 合体系统

#### 合体选项

**Necrozma** 可与两只传说宝可梦合体：

| 合体类型 | 合体对象 | 合体形态 | 属性 |
|---------|---------|---------|------|
| **Dusk Mane** | Solgaleo（索尔迦雷欧） | 黄昏之鬃 | 超能/钢 |
| **Dawn Wings** | Lunala（露奈雅拉） | 拂晓之翼 | 超能/幽灵 |

**合体后续**：
- 合体形态可进一步 **Ultra Burst** → 究极奈克洛兹玛
- 究极形态：超能/龙，种族值总和 754（最强形态）

---

#### 合体执行机制

**合体流程**：
1. 检测队伍中是否同时存在 Necrozma 和 Solgaleo/Lunala
2. 触发合体对话框，让玩家选择合体类型
3. 执行合体：
   - Necrozma 变为合体形态
   - 学习专属招式 **Photon Geyser**（光子喷涌）
   - 合体伙伴 HP **减半**，标记为 `fusedIntoNecrozma`

**合体伙伴处理**：
- 合体后，Solgaleo/Lunala 仍在队伍中
- HP 减半，但仍可战斗
- 如果 Necrozma 阵亡，合体伙伴恢复正常

---

#### Ultra Burst（究极爆发）

**触发条件**：
1. Necrozma 已合体为黄昏之鬃/拂晓之翼
2. 玩家已解锁 `enable_z_move` 机制
3. 点击 Ultra Burst 按钮
- 变为究极奈克洛兹玛

---

## 5.9 战斗引擎 NPC 宝可梦系统

### 系统概述

战斗引擎支持与 NPC 训练师进行完整的宝可梦对战。每个 NPC 拥有独特的队伍配置、战术风格和专属机制，数据定义在 `doc/pkm-tavern-plugin.js` 中。

---

### NPC 特色机制

#### 训练师熟练度系统

每个 NPC 拥有 **训练师熟练度**（0-255），影响：

- **对冲触发率**：高熟练度训练师更容易触发招式对冲
- **战术频率**：更频繁使用强化、换人等战术

**典型配置**：
- 普通训练师：150-200
- 精英训练师：200-230
- 冠军级别：230-255

---

#### 专属机制解锁

不同 NPC 解锁不同的战斗机制（这里以八位女主角为例）：

| NPC | 核心机制 | 特色 |
|-----|---------|------|
| **小优 (Gloria)** | 极巨化 | 伽勒尔冠军，全队可极巨化，G-Max 形态 |
| **小照 (Akari)** | 刚猛/迅疾 | 洗翠战术大师，灵活切换攻击模式 |
| **鸣依 (Rosa)** | 羁绊共鸣 | 全员王牌，共享情感值加成 |
| **莎莉娜 (Serena)** | Mega 进化 | 阿勃梭鲁 Mega 进化，魔法镜反弹 |
| **小遥 (May)** | Mega + 羁绊 | 火焰鸡加速接力，暴力推队 |
| **小光 (Dawn)** | Mega + 洞察 | 极致闪避命中，波克基斯畏缩锁 |
| **美月 (Selene)** | Z 招式 | 阿罗拉 Z 纯晶，专属 Z 招式 |

---

### 情感值系统

NPC 的宝可梦拥有完整的情感值配置（0-255）：

| 属性 | 效果 |
|------|------|
| **Trust（信赖）** | 残血锁血概率提升，更难击杀 |
| **Passion（激情）** | 暴击率提升，输出爆发 |
| **Insight（灵犀）** | 闪避率和命中率修正 |
| **Devotion（奉献）** | 自动回血概率，续航能力 |

**典型配置示例**：
- **小光的帕奇利兹**：Trust 255, Insight 200 → 极难命中的肉盾
- **小遥的火焰鸡**：Trust 255, Passion 255 → 暴击输出怪
- **小优的松鼠**：全属性 255 → 无敌王牌

---

### NPC 双打合并机制

双打或多实体战斗会触发 `doc/pkm-tavern-plugin.js` 中的 **队伍合并逻辑**，将同侧多名训练师整合为一支符合 6 槽上限的队伍，但目前没有具体的双打机制，体验上就是你用NPC的宝可梦：

1. **来源解析（`processTrainerParty`）**
   - 玩家：直接复用 ERA 变量里的队伍，或按 AI 点名从玩家盒子筛选。
   - 固定 NPC：优先从训练师数据库读出指定 Tier 队伍，可兼容 AI 临时点名。
   - 自定义 NPC / 野生：读取 AI 提供的名字或模板，缺失的字段交给生成器补全（自动抽性格、个体值、技能）。

2. **队伍整并（`mergeTrainerParties`）**
   - 将所有训练师的宝可梦打平成一支队伍，保留 `_trainerMetadata` 记录归属。
   - 超过 6 只则按随机/占比剔除多余个体，确保最终阵容合法。

3. **机制同步**
   - 自动扫描合并后的队伍，检测是否出现 Mega、极巨化、太晶、Z 招式等 mechanic。
   - 组合顺序：AI 指定 > 训练师原有配置 > 自动检测，生成最终 unlocks，确保需要的按钮都会出现。

4. **强度继承**
   - 取参与训练师中最高的 `trainerProficiency` 作为整队熟练度，匹配双打的难度感。
   - `battleData.player/enemy` 会记录 `_trainersData`，在战斗 UI 中可展示“双人联手”称号。

5. **兜底生成**
   - 若合并后仍存在 `_needGenerate` 标记，系统调用 `generateWildPokemon` 以默认 Tier 自动造怪，避免空槽或白板数据。

通过该流程，玩家只会看到一支打磨好的双打队伍，但后台仍完整保留每位 NPC 的个性、机制与台词触发条件。

---

### 个体配置

#### 种族值与努力值

NPC 宝可梦通常配置：
- **个体值（IV）**：多为 6V（全 31）
- **努力值（EV）**：252 满努力或自定义分配
- **性格**：针对性配置（如固执加攻、胆小加速）

#### 道具携带

NPC 会携带针对性道具：
- **Mega 石**：触发 Mega 进化
- **Z 纯晶**：释放 Z 招式
- **专爱道具**：讲究头带/围巾/眼镜
- **续航道具**：剩饭、文柚果
- **战术道具**：气腰、突击背心

---

## 5.10 地图机制与宝可梦刷新系统

### 地图结构

#### 五大区域

世界地图分为五大区域，每个区域有独特的生态和宝可梦分布：

| 区域 | 名称 | 中心坐标 | 特色 |
|------|------|----------|------|
| **Z 区** | ZENITH（中枢区） | (1, 1) | 中央安全区，新手友好 |
| **N 区** | NEON（霓虹区） | (12, -12) | 科技都市，电系/钢系 |
| **B 区** | BLOOM（盛放区） | (-13, -13) | 自然森林，草系/虫系 |
| **S 区** | SHADOW（暗影区） | (12, 12) | 暗影地带，幽灵/恶系 |
| **A 区** | APEX（极诣区） | (-13, 13) | 极寒高山，冰系/龙系 |

**区域判定**：基于玩家坐标的象限和距离自动判定

---

### 坐标系统

#### 显示坐标

玩家看到的坐标**跳过 0**：
- 负数：..., -3, -2, -1
- 正数：1, 2, 3, ...
- 中心点：(1, 1)

**示例**：
- 从 (1, 1) 向左走 → (0, 1) 不存在，直接到 (-1, 1)
- 从 (1, 1) 向下走 → (1, 0) 不存在，直接到 (1, -1)

---

### 宝可梦刷新机制

#### 生物群系系统

每个格子属于特定的**生物群系**（Biome Zone），决定刷新的宝可梦种类：

**典型生物群系**：
- **Aether_Admin_Zone**：以太基地，稀有宝可梦
- **Forest_Zone**：森林区域，草系/虫系
- **Ocean_Zone**：海洋区域，水系
- **Cave_Zone**：洞穴区域，岩石/地面系
- **Urban_Zone**：城市区域，普通系/电系

---

#### 稀有度系统（按威胁度动态变化）

`tavern-inject.js` 中的 `getRarityPool(threat)` 会根据**威胁度**抽取稀有度，和平区直接不刷新。各段概率如下：

| 威胁度 | common | uncommon | rare | boss* |
|--------|--------|----------|------|-------|
| 1（SAFE） | 79.5% | 17% | 3% | 0.5% |
| 2（LOW） | 75% | 17% | 6% | 2% |
| 3（MID） | 70% | 20% | 6% | 4% |
| 4（HIGH） | 60% | 25% | 9% | 6% |
| 5（APEX） | 50% | 30% | 20% | 10% |

> *“boss” 槽用于精英/异常个体，如果当前生物群系没有 boss 池，会自动降级到 rare / uncommon / common。

真正的 **传说/异兽** 判定与上表独立：
- **传说宝可梦**：若当前地块的 `surfacePool` 含有 `legendary` 池，每次刷新都会额外以 0.1%（1/1000）的概率抽取一次并插入结果，等级范围固定在 Lv70-90。与威胁度和异变无关。
- **悖谬/究极异兽**：仍由异变系统驱动（见下文），根据 `phenomenon` 状态另外注入，等级区间通常 55-65。

---

#### 威胁度与等级区间

刷新等级由 `getLevelRange(threat)` 决定，和平区（threat=0 或 `THREAT_PEACE`）完全不出怪。

| 威胁度 | 标签 | 等级范围 | 备注 |
|--------|------|----------|------|
| 1 | SAFE | Lv2-8 | 新手区，常见小怪 |
| 2 | LOW | Lv8-20 | 初期冒险 |
| 3 | MID | Lv20-40 | 进化前/准进化阶段 |
| 4 | HIGH | Lv40-60 | 高危区域，完全体出没 |
| 5 | APEX | Lv60-85 | 禁区级，准神/Boss |
| 0 / Peace | 和平区 | 无刷新 | 城镇/安全屋 |

等级计算完毕后还会触发 `evolveToLevel` / `EVOLVED_MIN_LEVEL` 保险逻辑，确保进化形态不会低于设定等级。

---

### 异变系统（Phenomenon）

#### 概述

`world_state.phenomenon` 保存当前异变状态 `{ active_type, active_region }`。每当 `PokemonSpawnSystem.spawnForGrid` 运行时，会先根据该状态调用 `spawnPhenomenonPokemon`，把异变宝可梦插入结果队列，然后才生成常规刷新。

#### 类型与刷新源

| active_type | 刷新源实体 | 行为 |
|-------------|-------------|------|
| `ancient` | **Paradox Anchors**（悖谬锚点） | 25% 概率在 **Pool** 锚点刷出对应古代悖谬；25% 概率在 **Elite/Boss** 锚点刷出预设 Boss。|
| `future` | **Paradox Anchors** | 同上，只是读取 `PARADOX_SPAWN_POOLS` 中 future 池或 `STATIC_BOSS_MAP` 的未来 Boss。|
| `ultra` | **Ultra Wormhole**（究极之洞） | 只要格子上有 wormhole，即刻刷出该洞绑定的究极异兽（无概率衰减）。|
| `clear` | -- | 不注入异变宝可梦。|

**等级与威胁**：
- Pool 刷新：`config.min` ~ `config.min + 9`，`threat = 8`。
- Elite/Boss 刷新：同区间，但 `threat = 10`，标记为 `paradox_boss`。
- Ultra Beast：`config.min` ~ `config.min + 9`，`threat = 10`，稀有度 `legendary`。

> 目前 `active_region` 仅用于界面提示（west/east/random），刷新逻辑只看格子是否存在对应实体，因此锚点/洞所在位置即可触发，无需位于指定大区。

#### 刷新流程（总结）
1. **Ancient/Future**：对当前格子的所有悖谬锚点逐一判定：
   - 名称以 `Elite_` 或 `Boss_` 开头 → 25% 刷出 `STATIC_BOSS_MAP` 中的固定 Boss。
   - 名称以 `Pool_` 开头且池类型与 active_type 匹配 → 25% 刷出池中任意一只。
2. **Ultra**：若格子含有究极之洞 ID（如 `UB_Nihilego`），直接生成对应异兽（等级 `min~min+9`）。
3. **Clear**：跳过异变注入，仅生成常规刷新。

#### 周期与区域

- **Day 1-7**：强制 `clear / none`（新手保护）。
- **Day ≥ 8**：进入 7 天轮换，由 `(day - 1) % 7` 决定：

| (day-1) % 7 | active_type | active_region | 说明 |
|-------------|-------------|---------------|------|
| 0 | `clear` | `none` | 休整日，不刷异变 |
| 1 | `ancient` | `west` | 两次 Ancient 周期均指向 west 组锚点 |
| 2 | `future` | `east` | Future 周期指向 east 组锚点 |
| 3 | `ultra` | `random` | Ultra 周期，区域在 `[A,B,N,S,Z]` 中随机一项 |
| 4 | `ancient` | `west` | 与 Day1+8 相同 |
| 5 | `future` | `east` | 与 Day2+8 相同 |
| 6 | `ultra` | `random` | 与 Day3+8 相同 |

`west/east` 目前只影响前端展示与提醒，真正能否刷出异变仍以地图上有没有相应锚点/洞为准。

---

### 地图实体

#### 地标系统

地图上有多种**地标实体**：

**服务设施**：
- **宝可梦中心**：回复队伍，存取宝可梦
- **商店**：购买道具和精灵球
- **PC 终端**：管理宝可梦盒子
- **警察亭**：任务和悬赏

**交通设施**：
- **传送点（Warp）**：快速传送到其他区域
- **交通站（Transit Station）**：地铁/巴士系统
- **熔岩线（Lava Line）**：火山地下铁
- **海洋航线（Sea Route）**：水上交通
- **天空网（Sky Net）**：飞行出租车

**异变实体**：
- **悖谬锚点（Paradox Anchors）**：刷新悖谬宝可梦
- **究极之洞（Ultra Wormhole）**：刷新究极异兽

---

### 位置上下文

系统自动生成**位置上下文**，包含：

1. **当前区域**：所在大区名称
2. **坐标**：显示坐标 (x, y)
3. **生物群系**：当前生态类型
4. **地标**：最近的地标和描述
5. **附近宝可梦**：可能出现的宝可梦列表
6. **异变警报**：当前异变状态（如有）
7. **服务设施**：附近的宝可梦中心、商店等
8. **NPC 信息**：附近的 NPC 住址

**刷新范围**：
- 以玩家为中心，半径 2 格范围
- 包含当前格 + 上下左右 + 四角 + 半径 2
- 共 13 个格子的宝可梦信息

---

### 系统特色

**地图系统提供**：
- **800+ 宝可梦**完整分布
- **动态异变**周期性刷新稀有宝可梦
- **完整地图实体**：地标、服务、交通
- **智能上下文**：自动生成环境描述
- **多语言支持**：30+ NPC 多语言触发

---